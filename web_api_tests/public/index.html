<!doctype html>
<html>
<head>
    <title>Moodify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login, #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }

        .area {
            fill: url("#temperature-gradient");
            clip-path: url(#clip);
        }

        .selection {
            fill: white;
            stroke: black;
            stroke-width: 2px;
            fill-opacity: 0;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

    </style>
</head>

<body>
<div class="container">
    <div id="login">
        <h1>This is an example of the Authorization Code flow</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
        <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
    </div>
</div>

<script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
        <div class="pull-left">
            <img class="media-object" width="150" src="{{images.0.url}}"/>
        </div>
        <div class="media-body">
            <dl class="dl-horizontal">
                <dt>Display name</dt>
                <dd class="clearfix">{{display_name}}</dd>
                <dt>Id</dt>
                <dd>{{id}}</dd>
                <dt>Email</dt>
                <dd>{{email}}</dd>
                <dt>Spotify URI</dt>
                <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                <dt>Link</dt>
                <dd><a href="{{href}}">{{href}}</a></dd>
                <dt>Profile Image</dt>
                <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                <dt>Country</dt>
                <dd>{{country}}</dd>
            </dl>
        </div>
    </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
        <dt>Access token</dt>
        <dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt>
        <dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>
    (function () {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        // let recents, artistsGraph, allLinks, tracks, topArtists, recentArtists, relatedArtists;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {
                // render oauth info
                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: access_token,
                    refresh_token: refresh_token
                });

                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function (response) {
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                        $.ajax({
                            url: '/data',
                            data: {
                                'access_token': access_token,
                                'refresh_token': refresh_token
                            }
                        }).done(function (receivedData) {
                            const recents = receivedData.recents.sort(function (a, b) {
                                return Date.parse("1970-01-01" + a.time.slice(a.time.indexOf('T'))) - Date.parse("1970-01-01" + b.time.slice(b.time.indexOf('T')));
                            });
                            const artistsGraph = receivedData.artistsGraph;
                            const tracks = receivedData.tracks;
                            const topArtists = receivedData.topArtists;
                            const recentArtists = receivedData.recentArtists;
                            const relatedArtists = receivedData.relatedArtists;

                            var link;
                            var node;
                            let buckets = [];
                            let currBuckets = [];
                            let gradientOffsets = [];

                            $('#login').hide();
                            $('#user-profile').hide();
                            $('#oauth').hide();
                            $('#obtain-new-token').hide();
                            $('#loggedin').show();

                            var div = d3.select("#loggedin").append("div")
                                .attr("class", "tooltip")
                                .style("opacity", 0);

                            var svg = d3.select("#loggedin").append("svg").attr("width", 1000).attr("height", 800),
                                margin = {top: 430, right: 20, bottom: 30, left: 40},
                                width = +svg.attr("width") - margin.left - margin.right,
                                height = +svg.attr("height") - margin.top - margin.bottom;

                            var simulation = d3.forceSimulation()
                                .force("link", d3.forceLink().id(d => d.id))
                                .force("charge", d3.forceManyBody())
                                .force("x", d3.forceX())
                                .force("y", d3.forceY())
                                .force("center", d3.forceCenter(width / 2, height / 2));

                            var x = d3.scaleTime().domain([new Date("Fri Jan 01 1970 0:00:00"), new Date("Fri Jan 02 1970 0:00:00")]).range([0, width]),
                                y = d3.scaleLinear().range([height, 0]);

                            var xAxis = d3.axisBottom(x);

                            var brush = d3.brushX()
                                .extent([[0, 0], [width, height]])
                                .on("brush end", brushed);

                            var area = d3.area()
                                .curve(d3.curveMonotoneX)
                                .x(function (d) {
                                    return x(d.time);
                                })
                                .y0(height)
                                .y1(function (d) {
                                    return y(d.arr.length);
                                });

                            svg.append("defs").append("clipPath")
                                .attr("id", "clip")
                                .append("rect")
                                .attr("width", width)
                                .attr("height", height);

                            var context = svg.append("g")
                                .attr("class", "context")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                            function parseToHours(date) {
                                let currentDate = Date.now();
                                return new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDay(),
                                    date.getHours(), date.getMinutes(), date.getSeconds(), date.getMilliseconds());
                            }

                            console.log(receivedData);
                            drag = simulation => {

                                function dragstarted(d) {
                                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                                    d.fx = d.x;
                                    d.fy = d.y;
                                }

                                function dragged(d) {
                                    d.fx = d3.event.x;
                                    d.fy = d3.event.y;
                                }

                                function dragended(d) {
                                    if (!d3.event.active) simulation.alphaTarget(0);
                                    d.fx = null;
                                    d.fy = null;
                                }

                                return d3.drag()
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended);
                            };

                            simulation
                                .nodes(artistsGraph.nodes)
                                .on("tick", ticked);

                            simulation.force("link")
                                .links(artistsGraph.links);

                            link = svg.append("g")
                                .attr("stroke", "#999")
                                .attr("stroke-opacity", 0.6)
                                .selectAll("line")
                                .data(artistsGraph.links.filter(function (d) {
                                    return (d.source.id in recentArtists || d.source.id in topArtists)
                                        && (d.target.id in recentArtists || d.target.id in topArtists)
                                }))
                                .enter().append("line")
                                .attr("stroke-width", d => Math.sqrt(d.value));

                            node = svg.append("g")
                                .attr("stroke", "#fff")
                                .attr("stroke-width", 1.5)
                                .selectAll("circle")
                                .data(artistsGraph.nodes.filter(function (d) {
                                    return d.id in recentArtists || d.id in topArtists
                                }))
                                .enter().append("circle")
                                .attr("r", 5)
                                .attr("fill", color)
                                .call(drag(simulation))
                                .on("mouseover", function (d) {
                                    d3.selectAll("circle").attr("opacity", 0.2);
                                    d3.select(this).attr("opacity", 1.0);
                                    div.style("opacity", 0.9).style("height", "14px");
                                    div.html(d.name)
                                        .style("left", (d3.event.pageX + 15) + "px")
                                        .style("top", (d3.event.pageY - 28) + "px")
                                        .style("width", d.name.length * 7 + "px");
                                })
                                .on("mouseout", function (d) {
                                    d3.selectAll("circle").attr("opacity", 1.0);
                                    div.style("opacity", 0);
                                    update_graph(currBuckets);
                                })
                                .on("click", function (d) {
                                    div.style("opacity", 0);
                                    update_graph(currBuckets, d.id); //gives id of node?
                                });

                            function ticked() {
                                link
                                    .attr("x1", d => d.source.x)
                                    .attr("y1", d => d.source.y)
                                    .attr("x2", d => d.target.x)
                                    .attr("y2", d => d.target.y);

                                node
                                    .attr("cx", d => d.x)
                                    .attr("cy", d => d.y);
                            }

                            let last_index = 0;
                            let next_index = 0;
                            for (let i = Date.parse("1970-01-01T00:00:00.000Z");
                                 i <= Date.parse("1970-01-02T00:00:00.000Z");
                                 i += Date.parse("1970-01-01T03:00:00.000Z")) {
                                next_index = recents.findIndex(function (elem, index) {
                                    return this.next_index <= index && this.i <= Date.parse("1970-01-01" + elem.time.slice(elem.time.indexOf('T'))); // i <= Date.parse(elem);
                                }, {'i': i, 'next_index': next_index});
                                if (next_index === -1) next_index = recents.length;
                                buckets.push({
                                    "time": (new Date(i + Date.parse("1970-01-01T05:00:00.000Z"))),
                                    "arr": recents.slice(last_index, next_index)
                                });
                                last_index = next_index;

                                if (i === Date.parse("1970-01-02T00:00:00.000Z")) buckets[0].arr = buckets[buckets.length - 1].arr;
                            }

                            currBuckets = buckets;

                            for (let i = 0; i < buckets.length; i++) {
                                let mean = d3.mean(buckets[i].arr.map(e => parseFloat(tracks[e.track].valence)));
                                if (!mean) mean = 0.5;
                                gradientOffsets.push({
                                    offset: (100 * i / (buckets.length - 1)) + "%",
                                    color: d3.interpolateRdBu(mean)
                                });
                            }

                            addGradient(gradientOffsets);

                            x.domain([new Date("1970-01-01T00:00:00.000"), new Date("1970-01-02T00:00:00.000")]);
                            y.domain([0, d3.max(buckets, d => d.arr.length)]);

                            context.append("path")
                                .datum(buckets)
                                .attr("class", "area")
                                .attr("d", area);

                            context.append("g")
                                .attr("class", "axis axis--x")
                                .attr("transform", "translate(0," + height + ")")
                                .call(xAxis);

                            context.append("g")
                                .attr("class", "brush")
                                .call(brush)
                                .call(brush.move, x.range());

                            function color(d) {  // coloring by genre
                                return 'black'
                            }


                            function update_graph(data, relatedToId=null) {
                                simulation.stop();

                                let all_recent_artists = [];
                                for (let i = 0; i < data.length; i++) {
                                    all_recent_artists.push(...data[i].arr.map(function (d) {
                                        return d.artist;
                                    }));
                                }

                                const new_links = artistsGraph.links.filter(function (d) {
                                    return all_recent_artists.includes(d.source.id) && all_recent_artists.includes(d.target.id)
                                });
                                const new_nodes = artistsGraph.nodes.filter(function (d) {
                                    return all_recent_artists.includes(d.id);
                                });
                                const related_links = artistsGraph.links.filter(function (d) {
                                    return (relatedToId === d.source.id || relatedToId === d.target.id) && !(new_links.includes(d));
                                });
                                let related_ids = [];
                                for (let related_link of related_links) {
                                    if (relatedToId === related_link.source.id) {
                                        related_ids.push(related_link.target.id);
                                    } else {
                                        related_ids.push(related_link.source.id);
                                    }
                                }
                                const related_nodes = artistsGraph.nodes.filter(function (d) {
                                    return related_ids.includes(d.id) && !(new_nodes.includes(d));
                                });

                                if (!(relatedToId in relatedArtists)) {
                                    new_nodes.push(...related_nodes);
                                }
                                node = node.data(new_nodes, function (d) {
                                    return d.id;
                                });
                                node.exit().remove();
                                const nodeEnter = node.enter().append("g");
                                node = nodeEnter.append("circle").merge(node)
                                    .attr("r", 5)
                                    .attr("fill", color)
                                    .call(drag(simulation))
                                    .on("mouseover", function (elem) {
                                        d3.selectAll("circle").attr("opacity", 0.2);
                                        d3.select(this).attr("opacity", 1.0);
                                        div.style("opacity", 0.9).style("height", "14px");
                                        div.html(elem.name)
                                            .style("left", (d3.event.pageX + 15) + "px")
                                            .style("top", (d3.event.pageY - 28) + "px")
                                            .style("width", elem.name.length * 7 + "px");
                                    })
                                    .on("mouseout", function (d) {
                                        d3.selectAll("circle").attr("opacity", 1.0);
                                        div.style("opacity", 0);
                                    })
                                    .on("click", function (d) {
                                        div.style("opacity", 0);
                                        update_graph(currBuckets, d.id);
                                    });

                                if (!(relatedToId in relatedArtists)) {
                                    new_links.push(...related_links);
                                }
                                link = link.data(new_links, function (d) {
                                    return d.source.id + d.target.id;
                                });
                                link.exit().remove();
                                link = link.enter().append("line").merge(link)
                                    .attr("stroke-width", d => Math.sqrt(d.value));

                                simulation.force("link").links(new_links);
                                simulation.nodes(new_nodes);
                                simulation.alphaTarget(0.3).restart();
                            }

                            function brushed() {
                                const s = d3.event.selection || x.range();
                                x.domain(s.map(x.invert, x));  //gives DateTime range that we want
                                currBuckets = buckets.filter(point => s.map(x.invert, x)[0] <= point.time && point.time <= s.map(x.invert, x)[1]);
                                update_graph(currBuckets);
                            }

                            function addGradient(gradientList) {
                                svg.append("linearGradient")
                                    .attr("id", "temperature-gradient")
                                    .attr("gradientUnits", "userSpaceOnUse")
                                    .attr("x1", "0%").attr("y1", "0%")
                                    .attr("x2", "100%").attr("y2", "0%")
                                    .selectAll("stop")
                                    .data(gradientList)
                                    .enter().append("stop")
                                    .attr("offset", function (d) {
                                        return d.offset;
                                    })
                                    .attr("stop-color", function (d) {
                                        return d.color;
                                    });
                            }
                        });
                    }
                });
            } else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }

            document.getElementById('obtain-new-token').addEventListener('click', function () {
                $.ajax({
                    url: '/refresh_token',
                    data: {
                        'refresh_token': refresh_token
                    }
                }).done(function (data) {
                    access_token = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: access_token,
                        refresh_token: refresh_token
                    });
                });
            }, false);
        }
    })();
</script>
</body>
</html>
